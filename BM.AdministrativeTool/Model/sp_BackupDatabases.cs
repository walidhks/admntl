using System;

namespace BM.AdministrativeTool.Model
{
	// Token: 0x02000008 RID: 8
	internal class sp_BackupDatabases
	{
		// Token: 0x17000015 RID: 21
		// (get) Token: 0x06000039 RID: 57 RVA: 0x0000224A File Offset: 0x0000044A
		public static string sp_Backup
		{
			get
			{
				return "\r\n\r\nUSE [master] \r\nGO \r\n/****** Object:  StoredProcedure [dbo].[sp_BackupDatabases] ******/ \r\nSET ANSI_NULLS ON \r\nGO \r\nSET QUOTED_IDENTIFIER ON \r\nGO \r\n \r\n-- ============================================= \r\n-- Author: Microsoft \r\n-- Create date: 2010-02-06\r\n-- Description: Backup Databases for SQLExpress\r\n-- Parameter1: databaseName \r\n-- Parameter2: backupType F=full, D=differential, L=log\r\n-- Parameter3: backup file location\r\n-- =============================================\r\n \r\nCREATE PROCEDURE [dbo].[sp_BackupDatabases]  \r\n            @databaseName sysname = null,\r\n            @backupType CHAR(1),\r\n            @backupLocation nvarchar(200) \r\nAS \r\n \r\n       SET NOCOUNT ON; \r\n           \r\n            DECLARE @DBs TABLE\r\n            (\r\n                  ID int IDENTITY PRIMARY KEY,\r\n                  DBNAME nvarchar(500)\r\n            )\r\n           \r\n             -- Pick out only databases which are online in case ALL databases are chosen to be backed up\r\n             -- If specific database is chosen to be backed up only pick that out from @DBs\r\n            INSERT INTO @DBs (DBNAME)\r\n            SELECT Name FROM master.sys.databases\r\n            where state=0\r\n            AND name=@DatabaseName\r\n            OR @DatabaseName IS NULL\r\n            ORDER BY Name\r\n           \r\n            -- Filter out databases which do not need to backed up\r\n            IF @backupType='F'\r\n                  BEGIN\r\n                  DELETE @DBs where DBNAME IN ('tempdb','Northwind','pubs','AdventureWorks')\r\n                  END\r\n            ELSE IF @backupType='D'\r\n                  BEGIN\r\n                  DELETE @DBs where DBNAME IN ('tempdb','Northwind','pubs','master','AdventureWorks')\r\n                  END\r\n            ELSE IF @backupType='L'\r\n                  BEGIN\r\n                  DELETE @DBs where DBNAME IN ('tempdb','Northwind','pubs','master','AdventureWorks')\r\n                  END\r\n            ELSE\r\n                  BEGIN\r\n                  RETURN\r\n                  END\r\n           \r\n            -- Declare variables\r\n            DECLARE @BackupName varchar(100)\r\n            DECLARE @BackupFile varchar(100)\r\n            DECLARE @DBNAME varchar(300)\r\n            DECLARE @sqlCommand NVARCHAR(1000) \r\n        DECLARE @dateTime NVARCHAR(20)\r\n            DECLARE @Loop int                  \r\n                       \r\n            -- Loop through the databases one by one\r\n            SELECT @Loop = min(ID) FROM @DBs\r\n \r\n      WHILE @Loop IS NOT NULL\r\n      BEGIN\r\n \r\n-- Database Names have to be in [dbname] format since some have - or _ in their name\r\n      SET @DBNAME = '['+(SELECT DBNAME FROM @DBs WHERE ID = @Loop)+']'\r\n \r\n-- Set the current date and time n yyyyhhmmss format\r\n      SET @dateTime = REPLACE(CONVERT(VARCHAR, GETDATE(),101),'/','') + '_' +  REPLACE(CONVERT(VARCHAR, GETDATE(),108),':','')  \r\n \r\n-- Create backup filename in path\\filename.extension format for full,diff and log backups\r\n      IF @backupType = 'F'\r\n            SET @BackupFile = @backupLocation+REPLACE(REPLACE(@DBNAME, '[',''),']','')+ '_FULL_'+ @dateTime+ '.BAK'\r\n      ELSE IF @backupType = 'D'\r\n            SET @BackupFile = @backupLocation+REPLACE(REPLACE(@DBNAME, '[',''),']','')+ '_DIFF_'+ @dateTime+ '.BAK'\r\n      ELSE IF @backupType = 'L'\r\n            SET @BackupFile = @backupLocation+REPLACE(REPLACE(@DBNAME, '[',''),']','')+ '_LOG_'+ @dateTime+ '.TRN'\r\n \r\n-- Provide the backup a name for storing in the media\r\n      IF @backupType = 'F'\r\n            SET @BackupName = REPLACE(REPLACE(@DBNAME,'[',''),']','') +' full backup for '+ @dateTime\r\n      IF @backupType = 'D'\r\n            SET @BackupName = REPLACE(REPLACE(@DBNAME,'[',''),']','') +' differential backup for '+ @dateTime\r\n      IF @backupType = 'L'\r\n            SET @BackupName = REPLACE(REPLACE(@DBNAME,'[',''),']','') +' log backup for '+ @dateTime\r\n \r\n-- Generate the dynamic SQL command to be executed\r\n \r\n       IF @backupType = 'F' \r\n                  BEGIN\r\n               SET @sqlCommand = 'BACKUP DATABASE ' +@DBNAME+  ' TO DISK = '''+@BackupFile+ ''' WITH INIT, NAME= ''' +@BackupName+''', NOSKIP, NOFORMAT'\r\n                  END\r\n       IF @backupType = 'D'\r\n                  BEGIN\r\n               SET @sqlCommand = 'BACKUP DATABASE ' +@DBNAME+  ' TO DISK = '''+@BackupFile+ ''' WITH DIFFERENTIAL, INIT, NAME= ''' +@BackupName+''', NOSKIP, NOFORMAT'        \r\n                  END\r\n       IF @backupType = 'L' \r\n                  BEGIN\r\n               SET @sqlCommand = 'BACKUP LOG ' +@DBNAME+  ' TO DISK = '''+@BackupFile+ ''' WITH INIT, NAME= ''' +@BackupName+''', NOSKIP, NOFORMAT'        \r\n                  END\r\n \r\n-- Execute the generated SQL command\r\n       EXEC(@sqlCommand)\r\n \r\n-- Goto the next database\r\nSELECT @Loop = min(ID) FROM @DBs where ID>@Loop\r\n \r\nEND\r\n";
			}
		}
	}
}
